name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (build without publishing)'
        required: false
        default: false
        type: boolean
  repository_dispatch:
    types: [release]

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout internal repo
        uses: actions/checkout@v4
        with:
          repository: tldraw/tldraw-internal
          token: ${{ secrets.INTERNAL_REPO_TOKEN }}

      - name: Calculate new version
        id: version
        working-directory: apps/public/desktop
        run: |
          CURRENT=$(node -p "require('./package.json').version")
          IFS='.' read -ra PARTS <<< "$CURRENT"
          MAJOR=${PARTS[0]}
          MINOR=${PARTS[1]}
          PATCH=${PARTS[2]}

          TYPE="${{ inputs.version_type || github.event.client_payload.version_type || 'patch' }}"

          case "$TYPE" in
            major) NEW_VERSION="$((MAJOR + 1)).0.0" ;;
            minor) NEW_VERSION="${MAJOR}.$((MINOR + 1)).0" ;;
            patch) NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))" ;;
          esac

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Current: $CURRENT -> New: $NEW_VERSION ($TYPE)"

  build-macos:
    needs: prepare
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout internal repo
        uses: actions/checkout@v4
        with:
          repository: tldraw/tldraw-internal
          token: ${{ secrets.INTERNAL_REPO_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install

      - name: Set version
        working-directory: apps/public/desktop
        run: node -e "const p=require('./package.json'); p.version='${{ needs.prepare.outputs.version }}'; require('fs').writeFileSync('package.json', JSON.stringify(p, null, '\t') + '\n')"

      - name: Build macOS (universal)
        working-directory: apps/public/desktop
        run: yarn fetch-llms && yarn electron-vite build && yarn electron-builder --mac --universal
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-macos
          path: |
            apps/public/desktop/dist/*.dmg
            apps/public/desktop/dist/*.zip
            apps/public/desktop/dist/*.blockmap
            apps/public/desktop/dist/latest-mac.yml
          if-no-files-found: error
          retention-days: 7

  publish:
    needs: [prepare, build-macos]
    runs-on: ubuntu-latest
    if: ${{ !inputs.dry_run }}
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | head -50

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: v${{ needs.prepare.outputs.version }}
          draft: false
          generate_release_notes: false
          body: |
            ## tldraw desktop v${{ needs.prepare.outputs.version }}
          files: |
            artifacts/release-macos/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
